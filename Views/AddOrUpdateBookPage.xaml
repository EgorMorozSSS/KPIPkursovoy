<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Course.Views.AddOrUpdateBookPage"
             xmlns:viewmodel="clr-namespace:Course.ViewModels"
             x:DataType="viewmodel:AddOrUpdateBookPageViewmodel"
             xmlns:controls="clr-namespace:Course.CustomControls"
             xmlns:models="clr-namespace:Course.Models"
             xmlns:converters="clr-namespace:Course.Converters"
             Title="{Binding Title}"
             BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource OffBlack}}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:StringNotEmptyConverter x:Key="StringNotEmptyConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Home" Command="{Binding NavigateToHomeCommand}"/>
    </ContentPage.ToolbarItems>

    <ScrollView>
        <VerticalStackLayout Padding="15" Spacing="15">
            <Border Style="{StaticResource CardStyle}">
                <VerticalStackLayout Spacing="15">
                    <Label Text="{Binding Title}" 
                           Style="{StaticResource SubHeadline}" 
                           HorizontalOptions="Center"/>
                    
                    <!-- Основные поля -->
                    <Label Text="Title:" Style="{StaticResource FieldLabel}"/>
                    <Entry Text="{Binding AddBookModel.Title}" 
                           Placeholder="Enter book title"
                           Style="{StaticResource PrimaryEntry}"/>
                    
                    <Label Text="Description:" Style="{StaticResource FieldLabel}"/>
                    <Editor Text="{Binding AddBookModel.Description}" 
                            Placeholder="Enter book description"
                            AutoSize="TextChanges"
                            HeightRequest="100"
                            Style="{StaticResource PrimaryEditor}"/>
                    
                    <Label Text="Genre:" Style="{StaticResource FieldLabel}"/>
                    <Picker ItemsSource="{Binding Genres}" 
                            SelectedItem="{Binding AddBookModel.Genre}"
                            Title="Select Genre"
                            Style="{StaticResource PrimaryPicker}"/>
                    
                    <!-- Изображение -->
                    <Label Text="Book Cover:" Style="{StaticResource FieldLabel}"/>
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                        <Button Text="Select Image" 
                                Command="{Binding SelectImageCommand}"
                                Style="{StaticResource SecondaryButton}"
                                Grid.Column="0"/>
                        
                        <HorizontalStackLayout Grid.Column="1" Spacing="5">
                            <Image Source="{Binding ImageSourceFile}"  
                                   WidthRequest="80" 
                                   HeightRequest="120"
                                   Aspect="AspectFit"/>
                            <controls:CustomImageControl Base64Source="{Binding AddBookModel.Image}" 
                                                         WidthRequest="80" 
                                                         HeightRequest="120"
                                                         Aspect="AspectFit"/>
                        </HorizontalStackLayout>
                    </Grid>
                    
                    <!-- Теги -->
                    <Label Text="Tags (comma-separated):" Style="{StaticResource FieldLabel}"/>
                    <Entry Text="{Binding TagsInput}" 
                           Placeholder="e.g., history, adventure, classic"
                           Style="{StaticResource PrimaryEntry}"/>
                    
                    <!-- Аудио -->
                    <Label Text="Audio File:" Style="{StaticResource FieldLabel}"/>
                    <Grid ColumnDefinitions="*,Auto">
                        <Button Text="Select Audio" 
                                Command="{Binding SelectAudioCommand}"
                                Style="{StaticResource SecondaryButton}"
                                Grid.Column="0"/>
                        
                        <Label Text="{Binding AudioFileName}"
                               IsVisible="{Binding AudioFileName, Converter={StaticResource StringNotEmptyConverter}}"
                               Style="{StaticResource CaptionLabel}"
                               VerticalOptions="Center"
                               Grid.Column="1"/>
                    </Grid>
                    
                    <!-- Кнопка сохранения -->
                    <Button Text="Save Book" 
                            Command="{Binding SaveDataCommand}"
                            Style="{StaticResource PrimaryButton}"
                            Margin="0,20,0,0"/>
                </VerticalStackLayout>
            </Border>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>