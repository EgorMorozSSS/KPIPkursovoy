<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Course.Views.BookDetailsPage"
             xmlns:viewmodel="clr-namespace:Course.ViewModels"
             xmlns:converters="clr-namespace:Course.Converters"
             xmlns:controls="clr-namespace:Course.CustomControls"
             xmlns:models="clr-namespace:Course.Models"
             x:DataType="viewmodel:BookDetailsPageViewmodel"
             Title="Book Details"
             BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource OffBlack}}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:StringNotEmptyConverter x:Key="StringNotEmptyConverter" />
            <converters:BoolToPlayPauseConverter x:Key="BoolToPlayPauseConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="15" Spacing="15">
            <!-- Обложка книги -->
            <Border Style="{StaticResource CardStyle}">
                <controls:CustomImageControl Base64Source="{Binding BookModel.Image}" 
                                             WidthRequest="300" 
                                             HeightRequest="450"
                                             HorizontalOptions="Center"/>
            </Border>

            <!-- Информация о книге -->
            <Border Style="{StaticResource CardStyle}">
                <VerticalStackLayout Spacing="15">
                    <!-- Основные детали -->
                    <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto" 
                          RowSpacing="10" ColumnSpacing="10">

                        <Label Text="Title:" 
                               Style="{StaticResource FieldLabel}"
                               Grid.Row="0" Grid.Column="0"/>
                        <Label Text="{Binding BookModel.Title}" 
                               Grid.Row="0" Grid.Column="1"/>

                        <Label Text="Genre:" 
                               Style="{StaticResource FieldLabel}"
                               Grid.Row="1" Grid.Column="0"/>
                        <Label Text="{Binding BookModel.Genre}" 
                               Grid.Row="1" Grid.Column="1"/>

                        <Label Text="ID:" 
                               Style="{StaticResource FieldLabel}"
                               Grid.Row="2" Grid.Column="0"/>
                        <Label Text="{Binding BookModel.Id}" 
                               Grid.Row="2" Grid.Column="1"/>

                        <Label Text="Listeners:" 
                               Style="{StaticResource FieldLabel}"
                               Grid.Row="3" Grid.Column="0"/>
                        <Label Text="{Binding BookDetailsStatsText}" 
                               Grid.Row="3" Grid.Column="1"/>

                        <Label Text="Tags:" 
                               Style="{StaticResource FieldLabel}"
                               Grid.Row="4" Grid.Column="0"/>
                        <Label Text="{Binding FormattedTags}" 
                               Grid.Row="4" Grid.Column="1"/>
                    </Grid>

                    <!-- Описание -->
                    <Label Text="Description:" Style="{StaticResource FieldLabel}"/>
                    <Label Text="{Binding BookModel.Description}" 
                           Style="{StaticResource BodyLabel}"/>
                </VerticalStackLayout>
            </Border>

            <!-- Аудиоплеер -->
            <Border Style="{StaticResource CardStyle}">
                <VerticalStackLayout Spacing="15">
                    <Label Text="Audio Player" 
                           Style="{StaticResource SubHeadline}" 
                           HorizontalOptions="Center"/>

                    <Slider Minimum="0"
                            Maximum="{Binding Duration.TotalSeconds}"
                            Value="{Binding ManualSliderValue, Mode=TwoWay}" 
                            ThumbColor="{StaticResource Primary}"
                            MinimumTrackColor="{StaticResource Primary}"/>

                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="10">
                        <Label Text="{Binding CurrentPosition}" Style="{StaticResource BodyLabel}"/>
                        <Label Text="/" Style="{StaticResource BodyLabel}"/>
                        <Label Text="{Binding Duration}" Style="{StaticResource BodyLabel}"/>
                    </HorizontalStackLayout>

                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="20">
                        <Button Text="⏪-10" 
                                Command="{Binding RewindCommand}" 
                                CommandParameter="-10"
                                Style="{StaticResource IconButton}"/>
                        <Button Text="⏪-15" 
                                Command="{Binding RewindCommand}" 
                                CommandParameter="-15"
                                Style="{StaticResource IconButton}"/>
                        <Button Text="{Binding IsPlaying, Converter={StaticResource BoolToPlayPauseConverter}}" 
                                Command="{Binding PlayPauseCommand}" 
                                Style="{StaticResource IconButton}"/>
                        <Button Text="⏩+10" 
                                Command="{Binding RewindCommand}" 
                                CommandParameter="10"
                                Style="{StaticResource IconButton}"/>
                        <Button Text="⏩+15" 
                                Command="{Binding RewindCommand}" 
                                CommandParameter="15"
                                Style="{StaticResource IconButton}"/>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Border>

            <!-- Отзывы -->
            <Border Style="{StaticResource CardStyle}">
                <VerticalStackLayout Spacing="15">
                    <Label Text="Reviews" 
                           Style="{StaticResource SubHeadline}" 
                           HorizontalOptions="Center"/>

                    <CollectionView ItemsSource="{Binding Reviews}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Review">
                                <Border Style="{StaticResource CardStyle}" Padding="10">
                                    <VerticalStackLayout>
                                        <Label Text="{Binding Content}" 
                                               Style="{StaticResource BodyLabel}"/>
                                        <Label Text="{Binding CreatedAt, StringFormat='Posted on {0:dd MMM yyyy HH:mm}'}"
                                               Style="{StaticResource CaptionLabel}"/>
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Border>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>